---
/**
 * Page: /requests
 * Employee view for managing own vacation requests
 */
import Layout from "@/layouts/Layout.astro";
import MyRequestsView from "@/components/requests/MyRequestsView.tsx";
import type { GetVacationRequestsResponseDTO } from "@/types";

export const prerender = false;

// Get authenticated user from middleware
const user = Astro.locals.user;
const supabase = Astro.locals.supabase;

if (!user) {
  return Astro.redirect("/login");
}

const currentUserId = user.id;

// Fetch user's vacation requests
const requestsResponse = await fetch(`${Astro.url.origin}/api/vacation-requests?userId=${currentUserId}`, {
  headers: {
    cookie: Astro.request.headers.get("cookie") || "",
  },
});

let initialRequests: GetVacationRequestsResponseDTO["data"] = [];
if (requestsResponse.ok) {
  const data: GetVacationRequestsResponseDTO = await requestsResponse.json();
  initialRequests = data.data;
}

// Fetch user's teams for calendar display
const { data: userTeams } = await supabase
  .from("team_members")
  .select(
    `
    team_id,
    teams:team_id (
      id,
      name
    )
  `
  )
  .eq("user_id", currentUserId);

interface TeamData {
  id: string;
  name: string;
}

const userTeamsList =
  userTeams?.map((tm) => ({
    id: (tm.teams as TeamData).id,
    name: (tm.teams as TeamData).name,
  })) || [];

// TODO: Fetch user's vacation allowance when endpoint is ready
// For now, use mock data
const mockAllowance = {
  totalDays: 26,
  usedDays: 10,
  remainingDays: 16,
  fromPreviousYear: {
    total: 5,
    utilizationDeadline: "2026-03-31",
  },
};
---

<Layout title="Moje Wnioski">
  <MyRequestsView
    client:load
    initialRequests={initialRequests}
    initialAllowance={mockAllowance}
    userTeams={userTeamsList}
  />
</Layout>
