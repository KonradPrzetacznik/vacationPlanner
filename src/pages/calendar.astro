---
/**
 * Team Calendar Page
 * Accessible at /calendar
 * Available for HR role only (as per PRD)
 * EMPLOYEE users see team calendar on /requests page instead
 */

import Layout from "@/layouts/Layout.astro";
import { CalendarView } from "@/components/calendar/CalendarView.tsx";
import { Toaster } from "@/components/ui/sonner";
import type { GetTeamsResponseDTO } from "@/types";

// Disable prerendering for this page
export const prerender = false;

// Get current user from middleware (authentication is already handled)
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Fetch current user profile with details
const { data: currentUserProfile, error: profileError } = await Astro.locals.supabase
  .from("profiles")
  .select("id, first_name, last_name, role")
  .eq("id", user.id)
  .single();

if (profileError || !currentUserProfile) {
  return Astro.redirect("/login");
}

// Access control is handled by middleware based on permissions.ts
// This page is accessible for HR role only

// Fetch teams available for current user
let teams: GetTeamsResponseDTO | null = null;
let errorMessage: string | null = null;
let initialTeamId: string | null = null;

// Read URL parameter for team selection
const urlTeamId = Astro.url.searchParams.get("teamId");

try {
  const apiUrl = new URL("/api/teams", Astro.url.origin);

  const response = await fetch(apiUrl.toString(), {
    headers: {
      cookie: Astro.request.headers.get("cookie") || "",
    },
  });

  if (response.ok) {
    teams = await response.json();

    // Set initial team ID from URL or first team in the list
    if (teams && teams.data && teams.data.length > 0) {
      if (urlTeamId && teams.data.some((team) => team.id === urlTeamId)) {
        // Use team from URL if it exists in the list
        initialTeamId = urlTeamId;
      } else {
        // Fallback to first team
        initialTeamId = teams.data[0].id;
      }
    }
  } else if (response.status === 403) {
    errorMessage = "Brak dostępu do zespołów";
  } else {
    errorMessage = "Nie udało się pobrać listy zespołów";
  }
} catch {
  errorMessage = "Wystąpił błąd podczas pobierania zespołów";
}
---

<Layout title="Kalendarz zespołu">
  {
    errorMessage ? (
      <div class="container mx-auto p-6">
        <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-red-800">{errorMessage}</div>
      </div>
    ) : teams && teams.data && teams.data.length > 0 && initialTeamId ? (
      <CalendarView
        client:load
        teams={teams.data}
        initialTeamId={initialTeamId}
        currentUser={{
          id: currentUserProfile.id,
          firstName: currentUserProfile.first_name,
          lastName: currentUserProfile.last_name,
          role: currentUserProfile.role,
        }}
      />
    ) : (
      <div class="container mx-auto p-6">
        <div class="rounded-lg border border-yellow-200 bg-yellow-50 p-4 text-yellow-800">
          Nie zarządzasz żadnym zespołem
        </div>
      </div>
    )
  }
  <Toaster client:load />
</Layout>
