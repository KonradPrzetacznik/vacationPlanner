---
/**
 * Team Calendar Page
 * Accessible at /calendar
 * Available for MANAGER and ADMINISTRATOR roles
 */

import Layout from "@/layouts/Layout.astro";
import { CalendarView } from "@/components/calendar/CalendarView.tsx";
import { Toaster } from "@/components/ui/sonner";
import type { GetTeamsResponseDTO } from "@/types";

// Disable prerendering for this page
export const prerender = false;

// Get current user from database
let currentUserId: string | null = null;
try {
  // Import DEFAULT_USER_ID for development
  const { DEFAULT_USER_ID } = await import("@/db/supabase.client");
  currentUserId = DEFAULT_USER_ID;
} catch (error) {
  console.error("Failed to get current user:", error);
}

if (!currentUserId) {
  return Astro.redirect("/login");
}

// Fetch current user profile to check role
const { data: currentUserProfile, error: profileError } = await Astro.locals.supabase
  .from("profiles")
  .select("id, first_name, last_name, role")
  .eq("id", currentUserId)
  .single();

if (profileError || !currentUserProfile) {
  console.error("Failed to fetch current user profile:", profileError);
  return Astro.redirect("/login");
}

// Check if user has required role
if (currentUserProfile.role !== "HR" && currentUserProfile.role !== "ADMINISTRATOR") {
  return Astro.redirect("/");
}

// Fetch teams available for current user
let teams: GetTeamsResponseDTO | null = null;
let errorMessage: string | null = null;
let initialTeamId: string | null = null;

// Read URL parameter for team selection
const urlTeamId = Astro.url.searchParams.get('teamId');

try {
  const apiUrl = new URL("/api/teams", Astro.url.origin);

  const response = await fetch(apiUrl.toString(), {
    headers: {
      cookie: Astro.request.headers.get("cookie") || "",
    },
  });

  if (response.ok) {
    teams = await response.json();

    // Set initial team ID from URL or first team in the list
    if (teams && teams.data && teams.data.length > 0) {
      if (urlTeamId && teams.data.some(team => team.id === urlTeamId)) {
        // Use team from URL if it exists in the list
        initialTeamId = urlTeamId;
      } else {
        // Fallback to first team
        initialTeamId = teams.data[0].id;
      }
    }
  } else if (response.status === 403) {
    errorMessage = "Brak dostępu do zespołów";
  } else {
    errorMessage = "Nie udało się pobrać listy zespołów";
  }
} catch (error) {
  console.error("Failed to fetch teams:", error);
  errorMessage = "Wystąpił błąd podczas pobierania zespołów";
}
---

<Layout title="Kalendarz zespołu">
  {errorMessage ? (
    <div class="container mx-auto p-6">
      <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-red-800">
        {errorMessage}
      </div>
    </div>
  ) : teams && teams.data && teams.data.length > 0 && initialTeamId ? (
    <CalendarView
      client:load
      teams={teams.data}
      initialTeamId={initialTeamId}
      currentUser={{
        id: currentUserProfile.id,
        firstName: currentUserProfile.first_name,
        lastName: currentUserProfile.last_name,
        role: currentUserProfile.role
      }}
    />
  ) : (
    <div class="container mx-auto p-6">
      <div class="rounded-lg border border-yellow-200 bg-yellow-50 p-4 text-yellow-800">
        Nie zarządzasz żadnym zespołem
      </div>
    </div>
  )}
  <Toaster client:load />
</Layout>
